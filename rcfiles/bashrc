# .bashrc

# Source global definitions
if [ -f /etc/bashrc ]; then
  . /etc/bashrc
fi

export WORKON_HOME=~/.virtualenvs
export PIP_VIRTUALENV_BASE=$WORKON_HOME
export PIP_RESPECT_VIRTUALENV=true

# Elephant mode
export HISTSIZE=100000
export HISTFILESIZE=
PROMPT_COMMAND="history -a; $PROMPT_COMMAND"

# Docker stuff
export DOCKER_URL='unix:///var/run/docker.sock'

export PS1='${PS1_MARKER}'"\W \[$(tput setaf 1)\]\$(__git_ps1 '(%s) ')\[$(tput setaf 3)\]\[$(tput bold)\]\\$ \[$(tput sgr0)\]"

PATH="$PATH:/usr/local/go/bin:/usr/local/heroku/bin:$HOME/.pokemon-terminal"
export PATH="$PATH:/opt/coursier/bin:$HOME/.local/share/coursier/bin"

# Tell fzf to use ag so that it ignores .gitignore stuff
export FZF_DEFAULT_COMMAND='ag -l ""'

# Always use gvim
alias vim=gvim

# Docked redis-cli for ease
alias redis-cli='docker run --net host --rm -it --entrypoint redis-cli redis'

# Useful aliases / definitions
alias purge_swap="find . -name '*.swp' -delete"

alias tmux='tmux -2'

# TMUX SHORTCUTS

# Wrap a command in a tmux session if not already in one
_in_tmux() {
  if [[ "$TMUX" != '' ]]; then
    $(tmux $*)
    return
  fi

  SESSION_NAME=auto-tmux-$RANDOM
  tmux new -d -s $SESSION_NAME -c $(pwd)
  $(tmux $* -t $SESSION_NAME )
  tmux attach -t $SESSION_NAME
}

dps() {
  $HOME/scripts/dps "$@"
}

dsbt() {
  /opt/docker-sbt/wrapper.sh "$@"
}

cdl() {
  $HOME/scripts/format/cdl "$@"
}

logs() {
  "$HOME/scripts/aws/logs" "$@"
}

# Kitty icat
icat() {
  kitty +kitten icat "$@"
}

ecr() {
  $(aws ecr get-login --no-include-email --region eu-west-1)
}

dcr() {
  local SERVICE="$1"
  docker-compose stop "$SERVICE" && docker-compose rm -f "$SERVICE" && docker-compose up -d "$SERVICE"
}

node() {
  docker run --rm -it node:latest
}

npm() {
  docker run --rm --entrypoint npm -v "$(pwd):/usr/src" -w /usr/src -it node:latest "$@"
}

alias vsplit='_in_tmux split -h'
alias hsplit='_in_tmux split -v'

alias qf="$HOME/scripts/quickfind"
alias centos='docker run --rm -it -w /mnt -v $(pwd):/mnt centos:latest /bin/bash'
alias amm='amm --banner "Ammonite started." --no-remote-logging'
alias mp='mplayer -geometry 0%:100%'

# Vim modes
alias vim-ocean='vim -c "color oceandeep"'
alias vim-midnight='vim -c "color midnight"'
alias vim-log='vim -c "color oceandeep" -c "AnsiEsc"'
alias viml=vim-log
alias vim-json='vim -c "set filetype=json"'

## OS-SPECIFIC ALIASES

if [[ ! -d /Library ]]; then
  # Linux-specific aliases
  unalias ls &> /dev/null
  unalias which &> /dev/null
  alias ls='ls --color=auto'
  alias which='(alias; declare -f) | /usr/bin/which --tty-only --read-alias --read-functions --show-tilde --show-dot'

  alias open=xdg-open
fi

unalias grep &> /dev/null
alias grep='grep --color=auto'
alias notes='vim -c RecentNotes'

alias ffmpeg='docker run -it --rm -v "$(pwd):/usr/src" --entrypoint /bin/bash -w /usr/src giftig/ffmpeg'

# Ensure symlinked dirs expand with trailing slash in autocomplete
bind 'set mark-symlinked-directories on'

export TERM=xterm-256color

# Shortcuts to some very useful scripts
ec2() {
  ~/scripts/aws/find-ec2 "$@"
}

conn() {
  ~/scripts/aws/ec2-connect "$@"
}

jira() {
  if [[ "$JIRA_SUBDOMAIN" == '' ]]; then
    echo 'Set the $JIRA_SUBDOMAIN in ~/.work' >&2
    return 1
  fi

  CARD="${1:-$(git rev-parse --abbrev-ref HEAD)}"
  if ! echo "$CARD" | grep -E '^[A-Z]{1,6}\-[0-9]{1,8}$' &> /dev/null; then
    echo "$CARD doesn't look like a ticket number" >&2
    return 1
  fi

  open "https://$JIRA_SUBDOMAIN.atlassian.net/browse/$CARD"
}

# Import other useful files
{
  . ~/.env
  . ~/.passwords
  . ~/.prettify
  . ~/.bashrc_venv
  . ~/.work
  . ~/.aliases
} &> /dev/null
